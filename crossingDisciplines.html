<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link href="css/style.css" rel="stylesheet" type="text/css" /> 
<link href="css/tipsy.css" rel="stylesheet" type="text/css" /> 
<script type="text/javascript" src="js/d3.min.js"></script>
<script type="text/javascript" src="js/jqueryMain.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52026122-1', 'spatialinformationdesignlab.org');
  ga('send', 'pageview');

</script>
	</head>
	<style>
</style>

<body>
<div id = "container"></div>
	<div id="title">Crossing Disciplines</div>
	<div id="clearAll">CLEAR
	</div>
    <div id="backNav">
    <a href="http://spatialinformationdesignlab.org/library/"><img src="backNav.png" width="15" height="15"></a>
  </div>

<div id = "exitGraph">
<img src="exitGraph.png" width="13" height="13">
</div>
<div id = "graphIcon">
<img src="graphs.png" width="20" height="20">
</div>
<div class = "outerCircleText"></div>
<div id = "hoverbox"></div>
<div class = "listBooks"></div>
<div class = "subjectText"></div>
<div id = "booksColumn">
<img src="books.png" width="30" height="20">
</div>
<div id = "exit">
<img src="exit.png" width="13" height="13">
</div>
<div id = "endIntro">
	EXIT GUIDE
</div>
<div id="inner">
</div>
		<div id="skip">Enter</div>

<div class="center">
		<div id="skip2">Exit Guide</div>
</div>
	<div class="intro"> 


	<div id="intro1" style="display: none; opacity: 0;">
	</div>
	<div id="intro2" style="display: none; opacity: 0;">
				<p><b>Crossing Disciplines</b> is a tool to explore the books in the Columbia University Libraries that are at the intersection of two or more disciplines.</p><p>Click two or more subjects around the ring - the top 25 most interdisciplinary subjects in the library - <b>or</b> mouseover inner circles to see their subject connections. Click one to reveal its collection of connected books.</p>
	<div id="introNav">
		<img src="forwardNav.png" width="15" height="15">
	</div>
	</div>
</div>
<!-- </div> -->
<div class="center">
	<div class="introZoom"> 

	<div id="intro4" style="display: none;">
				<p>Circles are placed on tiers according to how many subjects they are connected to </p>
	</div>
	<div id="intro4half" style="display: none;">
				<p><b>2</b> subjects at the outermost tier - many books are related to different pairs of subjects</p>
	</div>
	<div id="intro5" style="display: none;">
				<p><b>3</b> subjects for the next tier</p>
	</div>
	<div id="intro6" style="display: none;">
				<p><b>4</b> subjects</p>
	</div>
	<div id="intro7" style="display: none;">
				<p><b>5</b> subjects</p>
	</div>
	<div id="intro8" style="display: none;">
				<p>...and <b>6</b> subjects - there is only one collection of books related to 6 subjects</p>
	</div>
	<div id="intro8half" style="display: none;">
				<p>Use your mousewheel to zoom in and out of areas</p>
	</div>
	<div id="intro9" style="display: none;">
				<p>Each circle represents a collection of books related to a unique set of subjects</p>
	</div>
	<div id="intro10" style="display: none;">
				<p>Its <b>size</b> relates to how many books it contains. </p><p><b>1</b> in this case</p>
	</div>
	<div id="intro11" style="display: none;">
				<p>Mouseover and lines spike towards the related <b>3</b> subjects: Science, Art and Architecture</p>
	</div>
	<div id="intro12" style="display: none;">
				<p>And vice versa: </p>
				<p>Click on subjects around the ring to see which collections of books relate to those unique subjects</p>
	</div>
	<div id="intro13" style="display: none;">
				<p>The book list displays individual titles</p>
	</div>
	<div id="intro14" style="display: none;">
				<p>Click any title to view its record in the Columbia University Libraries.</p><p>The search might incite new discoveries amidst the 125,000 entries that include multiple disciplines in their catalogue description.</p>
	</div>
	</div>

		<div id="introNav2">
		<img src="forwardNav.png" width="10" height="10">
	</div>
</div>

	<div id="byline">
 <p>A digital library tool for multidisciplinary exploration.</p>
</div>
	<div id="subline">
		About
	</div>
	<div id="subline2">
		Guiding Notes
	</div>
	<div id="about">
	Project Team:

<p>Spatial Information Design Lab</p>

<p>Laura Kurgan, Project Director</p>

<p>Jen Lowe, Data Visualization and Data Analysis</p>

<p>  <a href="http://www.annelieberner.com" style="
    color: black;
    text-decoration: none;
">Annelie Berner</a>, Application and Design Development, D3 Progamming.</p>

<p>Columbia Library</p>

<p>Alex Gil, Jeffrey Lancaster, Barbara Rochenbach</p>

</div>
<div id="about2">
	<b>Subjects:</b>
	<p>Represented subjects are the 25 most interdisciplinary in the Columbia University Libraries. They are arranged around the ring according to frequency - where Claims etc.* has the highest frequency of connected books.</p>
	*Claims encompasses four subjects: Legislative Amendments, Military pensions, United States, and Claims.
	<b><p>Book Circles:</p></b>
	<p>Each circle represents a collection of books related to a unique combination of subjects. For example, Art, Architecture and Science have 1 book in common - the circle that represents this intersection is on the tier of circles with 3 connections. </p>
	<p>Each circle's diameter is scaled to how many books are in its "collection." </p>
	<p>The inner glyph shows the direction of the subjects it is related to - mouseover and the glyph will extend to touch those specific subjects. </p>
<div class="clickZoom"><b>Click here</b> for a guided explanation of the graphic.</div>

</div>
<div id="reset">RESET</div>

<script type = "text/javascript">
		loadBooks();

var colors = 
["#FFDAA0","#FFDAA0",
"#5ECBFF",
"#5ECBFF",
"#5ECBFF",
"#5ECBFF",
"#5ECBFF",
"#45E9E9",
"#45E9E9",
"#45E9E9",
"#45E9E9",
"#ADB3FF",
"#ADB3FF",
"#ADB3FF",
"#ADB3FF",
"#ADB3FF",
"#6F79F0",
"#6F79F0",
"#6F79F0",
"#6F79F0",
"#6F79F0",
"#6F79F0"]


var freqscale = 5; //size of circles
var  MAX_LEVELS = 20; //number larger than number of levels of circles
var conn_levels = [12, 12, 264, 209, 137, 77,12]; //how far away from the center each level is
var outer_level = [0,265];
var radius_levels = [0, 0, 240, 190, 125, 70, 0, 0, 0, 0]; //how far away from the center each level is
var MIN_LINE = 3.0; //length of the little ones
var TEXT_PAD_X = 5;
var TEXT_PAD_Y = 2;
var LEGEND_X_MARGIN = 20;
var LEGEND_SCALE = 0.0007;
//  Make an array of Subjects
var subjects;
//  Make an array of Connections
var connections;
var initialZoom = 1,
	maxZoom = 10;
var	windowWidth = window.outerWidth,
	windowHeight = window.innerHeight;
var boolSelected = 0;
var showReset = false;
var	width = 1440, //decided to make this constant rather than dynamic to window size and svg
	height = window.innerHeight;
var animateZoom = false;
var animateOpening =true;

d3.select("#container").style("pointer-events","none"); //while in intro text, you can't click on anything 
d3.select("#intro2")
	.transition()
	.style("display", "block")
	.style("opacity", 1.0)
	.each("end",function(){
		d3.select("g").transition().attr("opacity",.5)
		console.log(tigReggib)
		if (tigReggib>=connDataLength-100){ //keep track of how far we have progressed in loading data
					console.log(tigReggib)
		}
	});


$('#skip').fadeIn("slow");
var countProgress = 0;

$('#skip').on("click",function(){ //get out of the intro
	clearEverything();
	d3.selectAll("#intro2,.intro").transition().style("opacity", 0.0).style("display", "none");
	$('#skip').fadeOut("fast");	
	d3.select("#container").transition().style("opacity", 1);
	d3.select("g").transition().attr("opacity",1)
})



$('.clickZoom').on("click",function(){ //check out the zooming explanation
	clearEverything();
	d3.select("#container").style("pointer-events","none");
	$('#about2').fadeOut("slow");
	//have to set these at a constant to return to even though they move through the zooming explanation
	$(".introZoom").css("top","250px")
	$(".introZoom").css("width","240px")
	$("#introNav2").css("top","252px")
	$("#introNav2").css("left","796px")
	$("#skip2").show();
	d3.select("#container")
		.transition()
		.duration(1000)
		.style("opacity", .8)
		.each("end",function(){
		$(".introZoom")
		.animate().css("opacity",.8).show("fast", function(){
			$("#intro4").fadeIn("fast", function(){
				$(".introZoom").animate().css("height","inherit", "left","539px");		
			});
		$(".introZoom").animate({
			height:"inherit", 
			left:"539px"
		});
		animateZoom = true;
 		zoomOpening();	
		})
	})
})

$('#skip2').on("click",function(){ //get out of the zooming intro
	animateZoom = false;
	skipIntro2();
})

function skipIntro(){
clearEverything();
animateZoom = false;
d3.select("#container").transition().style("opacity", 1.0);
d3.selectAll("#intro1, #intro2, #introNav, .intro").transition().style("opacity", 0.0).style("display", "none");
$('#skip').fadeOut("slow");
d3.select("#container").style("pointer-events","auto");
}

function skipIntro2(){
d3.select("#container").transition().style("opacity", 1.0);
d3.selectAll("#intro1, #intro2, #intro3, #intro4, #intro4half, #intro5, #intro6, #intro7, #intro8, #intro8half,#intro9, #intro10, #intro11, #intro12, #intro13, #introNav, #introNav2, .intro, .introZoom").transition().style("display", "none");
$('#skip2').fadeOut("slow");
d3.select("#container").style("pointer-events","auto");	
for (i=0; i<conn_levels; i++){
	d3.selectAll(".ringCircle"+conn_levels[i]).transition().attr("stroke-width",1)
}
clearEverything();
$("#introNav2").hide();
animateZoom = false;
}

if(animateZoom==false){
$("#introNav2").hide(); //extra safe proofing to get rid of it as sometimes it would show if skip was called mid transition in zooming times
}

var svg = d3.select("#container") //our big main svg
    .append("svg")
	.attr({
      "width": "100%",
      "height": "100%",
  		});

var vis = svg //for the visualization
    .append('svg:g')
 	.attr("transform",
      "translate("+ 0 + "," + 0 + ")"); 

svg.call(d3.behavior.zoom() //setting up zoom abilities
   .scale(1.0)
   .scaleExtent([initialZoom, maxZoom]) 
   .on("zoom", function(){
		var t = d3.event.translate;
		var s = d3.event.scale;		
		zoomInOut(t, s);
	})
);

svg //don't let people zoom in all of these ways - will interrupt other functions of the program
.on("mousedown.zoom", null)
    .on("touchstart.zoom", null)
    .on("touchmove.zoom", null)
    .on("dblclick.zoom", null)
    .on("touchend.zoom", null);

var zoomInOut = function(t, s) {
	//showReset so people can reset when things get hard to control on zooms
if (showReset==true){
	$('#reset').slideDown("slow");
}
if (showReset==false){
	$('#reset').slideUp("slow");
}
if (s>=initialZoom){
	showReset = true;
}
if (s<initialZoom){
	showReset = false;
}

  vis.attr("transform",
      "translate("+d3.event.translate+ ")"
      + " scale(" + d3.event.scale + ")");
};

d3.select("#reset").on("click", resetZoom);

function resetZoom(){
console.log("reset viz")
   vis.attr("transform",
      "translate("+ 0 + "," + 0 + ")"
      + " scale(" + initialZoom + ")");
	showReset = false;
$('#reset').slideUp("slow");
};

var subjX=[];
var subjY=[];
var subjText=[];
var sData = [];
var subjCode = [];
var subjTextInside = [];
var subjLoc = [];
var freqIs=[];
var item;
var subradius = 325;
var scaling = 1.1;
var firstLoad = -1;
var tigReggib = -1;
var clicked = 0;
var checkedIt = [];
var wasItSubj;
var storeClicks = {};
var matching = 0;
var rectClicked = false;
var wordWidth = [];

//this is to make the ring of subjects 
function runOuterCircles(){
d3.tsv("subjects_top25_option1.tsv", function(error, data) {
var jump = Math.PI*2/data.length; 
var angle = 0;

var text = vis.selectAll('.subjectText')
	.data(data)
	.enter().append("text")
	.attr("class",function(d,i){
		subjCode.push(d.subjCode);
		freqIs.push(d.freq);
		subjLoc.push(d.loc);
		subjTextInside.push(d.subject);
		subjX.push(width*.5+subradius*Math.cos(jump*(d.loc-1)));
		subjY.push(height*.5+subradius*Math.sin(jump*(d.loc-1))); 
		return "subjectText"; 
	})
	.attr("x", function(d,i){ 
		if (subjX[i]>width/2){
			$(".subjectText").animate().css('text-align','left');
			return subjX[i]; 	
		}
		else {
			if (d.subject.length > 11){
				return subjX[i]-d.subject.length*3-55;			
			}
			if (d.subject.length<=11 &&d.subject.length>6){
				return subjX[i]-d.subject.length*3-25;			
			}
			else {
				return subjX[i]-d.subject.length*3-20;				
			}
		}
	})
	.attr("y", function(d,i){ 
		return subjY[i]; 
	})
	.text(function(d,i) { 
		return d.subject; 
	})
	.attr("fill", "black")
	.attr("opacity",1)
	.each(function(d) {
        d.width = this.getBBox().width; //get width of text box
      })
	.on("mouseover", function(d){
		d3.select(".surroundingPoints"+d.subjCode) //fill in colors upon beginning interaction
			.transition()
			.attr("stroke", colors[d.loc]);
	})
	.on("click", function(d,i){
		count=0;
		var d = this.__data__;
		console.log(d);
		wasItSubj = d.subjCode;
		storeClicks[i] = storeClicks[i] ? storeClicks[i]+1 : 1; //counting clicks on a subj box
		//need to clear book list out each time we might add or subtract a subject
		whichBooks.length = 0;
		booksChecked.length = 0;
		hideBooks();

		if(storeClicks[i]%2==1){ //if clicked ON
			console.log("clicked on"+storeClicks[i]%2)
			console.log("this is"+i)
			runLines(d.subjCode); //run lines to all the collections this subject is related to
			checkedIt.push(d.subjCode); //push subject codes to checkedIt
			checked(checkedIt); //find connection between these two subjects
		d3.select(".surroundingPoints"+d.subjCode) //make box around text big or clicked on
			.transition()
			.attr("y", subjY[i]-10)
			.attr("height",14);
		}
		if(storeClicks[i]%2==0){ //if unselected
			console.log("clicked off"+storeClicks[i]%2)
			d3.select(".surroundingPoints"+d.subjCode)
			.transition()
			.attr("y", subjY[i]+5)
			.attr("height",.1) //make clicked box small again
			for (c=0; c<checkedIt.length; c++){
				if (checkedIt[c]==d.subjCode){ //if the one you clicked OFF is part of the array
				checkedIt.splice(c,1); //splice it out of the array you are tracking
			}
		}
bookColors.length = 0;
d3.selectAll("circle.inCircle"+checkedIndex) //whichever circle was the intersection, turn it back off
	.transition()
	.attr("opacity",.1)
	.attr("fill","grey");
d3.selectAll(".checkedLinesOut").remove(); //remove the lines that show the special connection
d3.selectAll(".mouseoverText").remove(); //remove the text about the # books

checked(checkedIt); //re-show what the special connection is - may still be there if two other subjs still clicked
removeRunnedLines(d.subjCode);
}
});

//setting up underlying/underlining rectangles for the subject text
var surroundingRects = vis.selectAll("surroundingPoints")
	.data(data)
	.enter().append("rect")
	.attr("class", function(d,i){ return "surroundingPoints"+d.subjCode; })
	.attr("x", function(d,i){
		if (subjX[i]>width/2){
			return subjX[i]-5; 	
		}
		else {
			if (d.subject.length > 11){
				return subjX[i]-d.subject.length*3-58;			
			}
			if (d.subject.length<=11 &&d.subject.length>6){
				return subjX[i]-d.subject.length*3-28;			
			}
			else {
				return subjX[i]-d.subject.length*3-23;				
			}
		}
	})
	.attr("width", function(d,i){ 
		wordWidth.push(d.width);
		if (subjX[i]>width/2){
			return d.width+11;	
		}
		else{
			return d.width+8; //this.getBBox().width+3)
		}
	})
	.attr("y", function(d,i){  
		return height*.5+subradius*Math.sin(jump*(d.loc-1))+5;
	})
	.attr("height", .1)
	.attr("stroke-width","1px")
	.attr("fill","none")
	.attr("stroke", function(d,i){
		return "grey";
	})

$('.subjectText').tipsy({ 
		gravity: 'nw', 
		html: true, 
		title: function() {
		var d = this.__data__;
		var newNum = Math.round((d.freq) / 1000);
		var niceNum = numberWithCommas(newNum)+"k books";  
			return niceNum;
		}
});
})
}
function numberWithCommas(x) {
	return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

//functionality for graph section
var exitGraphsClicked = false;
$('#graphIcon').click(function(){
if (exitGraphsClicked==false){
	makeGraphsBig(); //an initial transitional reveal opening
}
if (exitGraphsClicked==true){
	justMakeGraphs(); //a simple change of opacity to reveal
}
d3.select("#graphIcon").transition().style("display","none");	
d3.select("#exitGraph").transition().style("display","block")
})
$('#exitGraph').click(function(){
exitGraphsClicked = true;
hideGraphs();
d3.select("#exitGraph").transition().style("display","none");	
d3.select("#graphIcon").transition().style("display","block");	
})

var mapLittleRect = d3.scale.linear()
	.domain([0, freqIs.length])
	.range([700,500]);
var maxFreq = d3.max(freqIs, function(d,i){return d; })
var legendMap = d3.scale.linear()
	.domain([0, maxFreq])
	.range([20,500]);
function hideGraphs(){
d3.selectAll(".rectsAre, .textsAre")
	.transition()
	.attr("opacity",0)
}
function justMakeGraphs(){
d3.selectAll(".rectsAre")
	.transition()
	.attr("opacity",.8)
d3.selectAll(".textsAre")
	.transition()
	.attr("opacity",1)
}

var secondVis = svg
    .append('svg:g')
 	.attr("transform",
      "translate("+ 0 + "," + 0 + ")")
function makeGraphsBig(){
d3.tsv("subjects_top25_option1.tsv", function(error, data) {
var mapRect = d3.scale.linear()
	.domain([0, freqIs.length])
	.range([680,440]); 

var graphRects = secondVis.selectAll("rectsAre")
	.data(data)
	.enter()
	.append("rect")
	.attr("class", function(d){ return "rectsAre"})
	.attr("x", function(d){
		return 0;
	})
	.attr("y", function(d,i){
		return 0;
	})
	.attr("width", function(d){
		return 0;
	})
	.attr("height",6)
	.attr("fill", function(d,i){
		return colors[d.loc];
	})
	.attr("opacity",.8)
var graphText = secondVis.selectAll("textsAre")
	.data(data)
	.enter()
	.append("text")
	.attr("class", function(d){ return "textsAre"})
	.attr("x", function(d){
		0;
	})
	.attr("y", function(d,i){
		console.log(mapRect(i))
		return windowHeight+100;
		})
	.text(function(d){
		return d.subject;
	})
	.attr("fill","black");
//now transition up	
d3.selectAll(".rectsAre")
	.transition()
	.duration(100)
	.attr("y", function(d,i){
		return mapRect(i);
	});
d3.selectAll(".rectsAre")
	.transition()
	.duration(200)
	.delay(300)
	.attr("width", function(d,i){
		return d.freq*LEGEND_SCALE;
	});
d3.selectAll(".textsAre")
	.transition()
	.delay(800)
	.attr("x", function(d){
		return d.freq*LEGEND_SCALE+5;		
	})
	.attr("y", function(d,i){
		return mapRect(i)+5;
	})
})
}
var bigBooks = [];
var saveBigIds = [];
var incomingBig;
var splitBig;
var angles = [];
var first = [];
var r = [];
var calcX=[];
var calcY=[];
var radiusIs = [];
var allCodes = [];	
var temp = [];
var thisThing;
var whatRadius = [];
var myVar;
var firstLoadVar;
var secondLoadVar;
var ready = 0;
var connDataLength;
//this gets called as soon as the page loads...
firstVariable();
function firstVariable(){
d3.tsv("connectionfreqcodes_top25.txt", function(error, cData) {
	connDataLength = cData.length;
})
}
////PROBLEM OF GETTING THIS VARIABLE BEFORE RUNNING OTHER FUNCTIONS
firstLoadVar = setInterval(function(){ 
if (connDataLength>0){
	if (firstLoad<connDataLength-1){
		d3.tsv("connectionfreqcodes_top25.txt", function(error, cData) {
		firstLoad++; 
		if (firstLoad>=0){
			storeInnerSubjs(cData[firstLoad].codeName, firstLoad); //store inner subjects is the loading function for the big data		
		}
		})
	}
	else {
	runOnce(); //once you have loaded everything in, then run the visual elements
	clearInterval(firstLoadVar); //and stop loading stuff in
	}
}
},1);	

function runOnce(){
runInnerCircles(); //inner collection
runOuterCircles(); //outer subjects
}

var countLittleCircle = 0;
var littleCircIndex;
var littleCircChecked = [];
var circleFreq = [];
function runInnerCircles(){
d3.tsv("connectionfreqcodes_top25.txt", function(error, cData) {
for (i = 0; i < cData.length;i++) {
	allCodes.push(cData[i].codeName);
	angles.push(holdAngles[i]); //created below
	radiusIs.push(radius_levels[storeLengths[i]]); //created below
	circleFreq.push(cData[i].freq);
}

for (i=0; i<allCodes.length; i++){
	r.push(allCodes[i].split(","));
}
//light circles to further articulate which ring of connections the circles are on top of
var ringCircle = vis.selectAll("ringCircle")
	.data(conn_levels)
	.enter()
	.append("circle")
	.attr("class",function(d,i){ return "ringCircle"+d; })
	.attr("cx",width/2)
	.attr("cy",height/2)
	.attr("r", function(d){
		return d;
	})
	.attr("fill","none")
	.attr("opacity",.1)
	.attr("stroke","lightgray")
	.attr("stroke-width",.5)
//each circle represents a collection of books related to a unique set of subjects...
var inCircle = vis.selectAll("inCircle")
	.data(cData)
	.enter().append("circle")
	.attr("class", function(d,i){ 
		calcX.push(width*0.5+scaling*radiusIs[i]*Math.cos(angles[i]));
		calcY.push(height*0.5+scaling*radiusIs[i]*Math.sin(angles[i]));
		whatRadius.push(Math.log(d.freq+2.0)*freqscale/2);
		return "inCircle"+i; 
	})
	.attr("cx", function(d,i){
		return width*0.5+scaling*radiusIs[i]*Math.cos(angles[i]); //positionining 
	})
	.attr("cy", function(d,i){ 
		return height*0.5+scaling*radiusIs[i]*Math.sin(angles[i]);
	})
	.attr("r", function(d){
		return (Math.log(d.freq+2.0)*freqscale/2);
	})
	.attr("fill", "gray")
	.attr("opacity",.1)
	.attr("stroke","white")
	.attr("stroke-width",1)
	.on("mouseover", function(d,i){
		d3.select(this)
		.attr("opacity", .9);
		index = i;
		allOut(d.codeName, index); //when you mouseover, shoot lines out to related subjects
		})
	.on("mouseout", function(d,i){
		console.log(countLittleCircle%2==0)
		if(countLittleCircle%2==0){
		d3.select(this)
		.attr("opacity",.1)
		removeOutwardLines(d.codeName, i); 
		}
	})

	.on("click", function(d,i){
		console.log("clicked little circle for books")
		console.log(d.codeName+"d.codeName on click of little circle")
		countLittleCircle++;
		console.log(countLittleCircle%2+"countLittleCircle")
		littleCircChecked.length=0;

	if (countLittleCircle%2==0){ //just in case it's been clicked "OFF"
		d3.select(this)
		.transition()
		.attr("fill","grey")
		.attr("opacity",.1)
		removeOutwardLines(d.codeName, i); //FIX CODENAME
		d3.select("#container").transition().style("opacity", 1);
		d3.selectAll(".mouseoverText").remove();	
		hideBooks();			
	}
	else if (countLittleCircle%2==1){ //clicked ON
		d3.select("#container")
		.style("pointer-events","none")
		.transition()
		.style("opacity", ".3");

		d3.select(this)
		.transition()
		.attr("fill","yellow");
		littleCircChecked.push(d.codeName);
		littleCircIndex = i;

		books(d.codeName,i); 
	}
});
makeGlyph();    
function makeGlyph(){
myVar = setInterval(function(){ 
if (tigReggib<connDataLength-1){
	tigReggib++; 
	runLinesOut(cData[tigReggib].codeName, tigReggib); //run lines out and in to make the glyph one by one with tigreggib...
}
else {}

},1);
if (tigReggib>=connDataLength-1){
	clearInterval(myVar); //stop once you've gone through full data set
}
}
})
//THIS IS A CLUDGY WAY TO DEAL WITH THE PARTICULARLY HUGE COLLECTIONS OF BOOKS - 
//SENDING THEM TO GET PREPROCESSED IN CASE SOMEONE CLICKS ON THEM
processBigs1("1,1",0);
processBigs1("1,21",1);
processBigs1("1,21,2",2);
processBigs1("5,20",3);
processBigs1("5,12",4);
processBigs1("9,7",5);
}

var thisIs = [];
var otherThis = [];
var storeLengths = [];
var countLengths = {};
var jumps = {};
var anglesAre = [];
var holdAngles = [];
var countIt = 0;
var thisCircle;
function storeInnerSubjs(arrayOfSubjs, index){
otherThis = arrayOfSubjs.split(",");
storeLengths.push(otherThis.length); //how many subjects a given collection is related to
countLengths[otherThis.length] = countLengths[otherThis.length] ? countLengths[otherThis.length]+1 : 1; //storing that
checkLengths(otherThis,index); //here we finish counters array and create the new jumps thing
}
var stop;
function checkLengths(otherThis,index){
for (i=0; i<MAX_LEVELS; i++){
	anglesAre[i] = 0;
	if (countLengths[i]===undefined){
		console.log("undefined");
		countLengths[i] = 0;
	}
	else {}
	jumps[i]=((Math.PI*2)/countLengths[i]); //PLACING CIRCLES ON LEVEL OF CONNECTIONS - count lengths is number of subjects it is related to
}
if (index==connDataLength-1){
	console.log(connDataLength);
	newFunction(); //run the new function if we've prepped the data
}
}
function newFunction(){
var onlyThis = 3;
console.log(jumps[3]);
for (i=0; i<storeLengths.length; i++){
	anglesAre[storeLengths[i]]+=jumps[storeLengths[i]];
	holdAngles.push(anglesAre[storeLengths[i]]);
}	
}

var count = 0;
var theseNums = [];
var boolUnselect = 0;
var checkedToString;
var checkedIndex;
function checked(checkedIt){
boolUnselect = 1;
theseNums = checkedIt;
var chckdLines = vis.selectAll("checkedLines")
	.data(r) //r is a data set of all codenames split at their commas
	.enter()
	.append("l")
	.attr("class", function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){ //for each element of each array of each entry
			if (d[j]<5){ //if that element is less than five, then push a 1 instead - this is for claims etc.
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]); //if not, don't worry about it, push the subj code as is
			}
		}
		newThing.sort(function(a, b){return a-b}); //sort it so that it's consistent when we check book subject codes
		theseNums.sort(function(a, b){return a-b});
			if(theseNums.toString()==newThing.toString()){ //if incoming numbers are the same thing as any of our polished new look at the old version of the data (so it used to have a 1234 now it only has a 1, just like theseNums dataset)
				count = 1;
				console.log(i+"this is index?");
				d3.select("circle.inCircle"+i)
				.transition()
				.attr("opacity", ".9")
				.attr("fill","yellow"); //let's highlight that circle that is at the connection spot
				console.log(checkedIt+"and i"+i)

				checkedIn(checkedIt, i); //let's draw lines out to the subjects related
				
				checkedIndex = i;
				matching = 1;
				
				d3.select("#booksColumn").classed("selected", true); //we will have books related
				d3.select("#booksColumn.selected").transition().style("display","none");	
				d3.select("#exit").transition().style("display","block")
		
				otherBooks(checkedIt,checkedIndex); //send our info over to be prepped for books display

				$('#exit').click(function(){ 
				booksChecked.length = 0;
				matching = 0;
				hideBooks();
				})
			}
			else {
				count++;
				d3.select("circle.inCircle"+i)
				.transition()
				.attr("fill", "gray")
			}
		if (count%allCodes.length==0){
		console.log("hiding, removing")
		d3.select("#booksColumn.selected").classed("selected", false);	
		matching = 0;
		d3.selectAll(".mouseoverText").remove();	
		hideBooks();			
		}
		else {
		d3.select("#booksColumn.selected").classed("selected", true);	
		}
		return "checkedLines";
	})
}

//when you click the book icon you will get the list of books related to the subjects
$('#booksColumn').click(function(){
if(littleCircChecked.length==0 && matching==1 || count%allCodes.length>0){
d3.select("#booksColumn.selected").transition().style("display","none");	
d3.select("#exit").transition().style("display","block")
otherBooks(checkedIt,checkedIndex); 
}
})

$('#exit').click(function(){
booksChecked.length = 0;
hideBooks();
matching = 0;
})

if (matching==1){
booksChecked.length = 0;
hideBooks();	
}

//GOT THIS FAR IN COMMENTING. 6/24
var linesInG;
function runLines(passSubjNum){
console.log(passSubjNum+"running lines");
var thisNum = passSubjNum;

linesInG = vis.selectAll("linesIn")
	.data(r)
	.enter()
	.append("line")
	.attr("transform", function(d,i){
		return "translate(" + (calcX[i]) + "," + (calcY[i]) + ")";
	})
	.attr("class", function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		for (n=0; n<newThing.length; n++){
			if (thisNum==newThing[n]){
			for (k=0; k<=subjCode.length; k++){
				if(subjCode[k]==thisNum){
				return "linesIn"+subjCode[k];
			}
		}
		}				
		}
	})
	.attr("x1",0)
	.attr("y1",0)
	.attr("x2",function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		for (n=0; n<newThing.length; n++){
			if (thisNum==newThing[n]){
			for (k=0; k<=subjCode.length; k++){
				if(subjCode[k]==thisNum){

		if (subjX[k]>width/2){
			return (subjX[k]-5)-calcX[i]; 	
		}

////////////HERE WE ARE DEALING WITH SUBJECT PLACEMENT

		if (subjX[k]<width/2) {
			if (subjTextInside[k].length > 11){
			return ((subjX[k]-(subjTextInside[k].length*3)-49)+wordWidth[k])-calcX[i];
			}
			if (subjTextInside[k].length<=11 &&subjTextInside[k].length>6){
			return ((subjX[k]-(subjTextInside[k].length*3)-19)+wordWidth[k])-calcX[i];
			}
			else{
			return ((subjX[k]-(subjTextInside[k].length*3)-14)+wordWidth[k])-calcX[i];			
			}
		}

		if(subjX[k]==width/2){
			return (subjX[k]-(subjTextInside[k].length*3-14+wordWidth[k]/4))-calcX[i];
		}

			}
			}
			}				
		}
	})
	.attr("y2",function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		for (n=0; n<newThing.length; n++){
			if (thisNum==newThing[n]){
			for (k=0; k<=subjCode.length; k++){
				if(subjCode[k]==thisNum){

		if (subjY[k]>height/2){
			return subjY[k]-calcY[i]-11; 	
		}
		if (subjY[k]<height/2){
			return subjY[k]-calcY[i]+5;
		}
		if(subjY[k]==height/2){
			return subjY[k]-calcY[i]+3;			
		}
			}
			}
			}				
		}
	})
	.attr("stroke",function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		for (n=0; n<newThing.length; n++){
			if (thisNum==newThing[n]){
		var whichLoc;
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==thisNum){
				whichLoc = subjLoc[k];
		return colors[whichLoc];
			}	
		}
	}
}
	})
	.attr("opacity",.4)
	.attr("stroke-width",1);
}

function removeRunnedLines(passSubjNum){
console.log(passSubjNum+"removing runned lines");
var thisNum = passSubjNum;
d3.selectAll(".linesIn"+passSubjNum)
	.transition()
	// .duration(10)
	// .attr("opacity",0)
	.attr("x2",0)
	.attr("y2",0)
}

//for litte circles
function runLinesOut(arrayOfSubjs, index){
// if (index>300){
	// console.log(index)
// }


thisIs = arrayOfSubjs.split(",");

thisCircle = index;
var justOne = thisIs[0];
var grabIt = [];
var newG = vis.selectAll("linesOut")
	.data(thisIs)
	.enter()
	.append("line")
	.attr("transform", function(d,i){
		return "translate(" + (calcX[thisCircle]) + "," + (calcY[thisCircle]) + ")";
	})
	.attr("class", "hey"+thisCircle)//"linesOut")
	.attr("x1", 0)
	.attr("y1",0)
	.attr("x2",0)
	.attr("y2",0)
	.attr("stroke",function(d,i){
					if (d<5){
						d = 1;
					}
					else if (d>=5){
						d = d;
					}	

		var whichLoc;
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
				whichLoc = subjLoc[k];
				// console.log(subjCode[k]+"subj code all out")
				return colors[whichLoc];
			}	
		}

		// return "lightgray";
	})
	.attr("stroke-width",1)
	.attr("opacity",.6);
	d3.selectAll("line.hey"+thisCircle)
		.transition()
		.attr("x2",function(d,i){
			if (d<5){
				d = 1;
			}
			else if (d>=5){
				d = d;
			}		
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
					return (subjX[k]-calcX[thisCircle])/(300/whatRadius[thisCircle]);
				}
			}
		})
		.attr("y2",function(d){
					if (d<5){
						d = 1;
					}
					else if (d>=5){
						d = d;
					}	
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
					return (subjY[k]-calcY[thisCircle])/(300/whatRadius[thisCircle]);
				}
			}
	})

}

var newG;
function checkedIn(arrayOfSubjs, index){
		d3.select("#booksColumn.selected").transition().style("display","none");	
		d3.select("#exit").transition().style("display","block")

thisIs = arrayOfSubjs;

thisCircle = index;
console.log(thisIs+"checkedIn")
var justOne = thisIs[0];
var grabIt = [];
var mouseText = vis.selectAll("mouseoverText")
	.data(thisIs)
	.enter()
	.append("text")
	.attr("class","mouseoverText")
	.attr("transform", function(d,i){
		return "translate(" + (calcX[thisCircle]+1) + "," + (calcY[thisCircle]-3) + ")";
	})
	.attr("fill","black")
	// .text(circleFreq[thisCircle]+" books")
	.text(function(){
		if (circleFreq[thisCircle]>1){
			return circleFreq[thisCircle]+" books"
	}
		else {
			return circleFreq[thisCircle]+" book"
	}
});

newG = vis.selectAll("checkedLinesOut")
	.data(thisIs)
	.enter()
	.append("line")
	.attr("transform", function(d,i){
d3.selectAll(".linesIn"+d)
.transition()
.attr("opacity",.1);

		return "translate(" + (calcX[thisCircle]) + "," + (calcY[thisCircle]) + ")";
	})
	.attr("class","checkedLinesOut")
	.attr("opacity",1)
	.attr("x1", 0)
	.attr("y1",0)
	.attr("x2",function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	
		for (k=0; k<subjCode.length; k++){
			if (subjCode[k]==d){

				if (subjX[k]>width/2){
					return (subjX[k]-5)-calcX[thisCircle]; 	
				}

//////////////HERE WE ARE DEALING WITH SUBJECT PLACEMENT
			if (subjTextInside[k].length > 11){
			return ((subjX[k]-(subjTextInside[k].length*3)-49)+wordWidth[k])-calcX[thisCircle];
			}
			if (subjTextInside[k].length<=11 &&subjTextInside[k].length>6){
			return ((subjX[k]-(subjTextInside[k].length*3)-19)+wordWidth[k])-calcX[thisCircle];
			}
			if(subjTextInside[k].length<=6) {
			return ((subjX[k]-(subjTextInside[k].length*3)-14)+wordWidth[k])-calcX[thisCircle];
			}
		if(subjX[k]==width/2){
			return ((subjX[k]-(((subjTextInside[k].length*3)-14)+wordWidth[k])/4))-calcX[thisCircle];
		}



}
}
})
	.attr("y2",function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	
		for (k=0; k<subjCode.length; k++){
			if (subjCode[k]==d){
		if (subjY[k]>height/2){
			return subjY[k]-calcY[thisCircle]-11; 	
		}
		if (subjY[k]<height/2){
			return subjY[k]-calcY[thisCircle]+5;
		}
		if(subjY[k]==height/2){
			return subjY[k]-calcY[thisCircle]+3;			
		}
		}
		}
	})
	.attr("stroke",function(d,i){
		var whichLoc;
					if (d<5){
						d = 1;
					}
					else if (d>=5){
						d = d;
					}	
			for (k=0; k<subjCode.length; k++){
				if (subjCode[k]==d){
				whichLoc = subjLoc[k];
				// console.log(whichLoc+"whichLoc all out")
				return colors[whichLoc];
			}	
		}
	})
	.attr("stroke-width",1);
}

function allOut(arrayOfSubjs, index){
thisIs = arrayOfSubjs.split(",");
thisCircle = index;

var justOne = thisIs[0];
var grabIt = [];
if(animateZoom==false){
var mouseText = vis.selectAll("mouseoverText")
	.data(thisIs)
	.enter()
	.append("text")
	.attr("class","mouseoverText")
	.attr("transform", function(d,i){
		return "translate(" + (calcX[thisCircle]+6) + "," + (calcY[thisCircle]-5) + ")";
	})
	.attr("fill","black")
	.text(function(){
		if (circleFreq[thisCircle]>1){
			return circleFreq[thisCircle]+" books"
	}
		if (circleFreq[thisCircle]==1){
			return circleFreq[thisCircle]+" book"
	}
	})
	// .text(circleFreq[thisCircle]+" books");
}




var newG = vis.selectAll("linesOut")
	.data(thisIs)
	.enter()
	.append("line")
	.attr("class", "hey"+thisCircle)//"linesOut")
	.attr("transform", function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	

		var whichLoc;
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
				whichLoc = subjLoc[k];
	d3.selectAll(".surroundingPoints"+subjCode[k])
	.transition()
	// .attr("height",10)
	.attr("stroke", colors[whichLoc]);
			}	
		}
		return "translate(" + (calcX[thisCircle]) + "," + (calcY[thisCircle]) + ")";
	})
	.attr("x1", 0)
	.attr("y1",0)
	.attr("stroke",function(d,i){
					if (d<5){
						d = 1;
					}
					else if (d>=5){
						d = d;
					}	

		var whichLoc;
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
				whichLoc = subjLoc[k];
				return colors[whichLoc];
			}	
		}
	})
	.attr("stroke-width",1)
	.attr("x2",function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	
		for (k=0; k<subjCode.length; k++){
			if (subjCode[k]==d){

		if (subjX[k]>width/2){
			return (subjX[k]-4)-calcX[thisCircle]; 	
		}
////////////another place to deal with subject placement
			if (subjTextInside[k].length > 11){
			return ((subjX[k]-(subjTextInside[k].length*3)-50)+wordWidth[k])-calcX[thisCircle];
			}
			if (subjTextInside[k].length<=11 &&subjTextInside[k].length>6){
			return ((subjX[k]-(subjTextInside[k].length*3)-20)+wordWidth[k])-calcX[thisCircle];
			}
			else {
			return ((subjX[k]-subjTextInside[k].length*3-15)+wordWidth[k])-calcX[thisCircle];				
			}
		if(subjX[k]==width/2){
			return ((subjX[k]-(((subjTextInside[k].length*3)-15)+wordWidth[k])/4))-calcX[thisCircle];
		}
			}
		}
	})
	.attr("y2",function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	
		for (k=0; k<subjCode.length; k++){
			if (subjCode[k]==d){
		if (subjY[k]>height/2){
			return subjY[k]-calcY[thisCircle]+5; 	
		}
		if (subjY[k]<height/2){
			return subjY[k]-calcY[thisCircle]+5;
		}
		if(subjY[k]==height/2){
			return subjY[k]-calcY[thisCircle]+5;			
		}
		}
		}
	});
}
function removeOutwardLines(codes, thisCirc){
var outToText = vis.selectAll("outText") //not outText
d3.selectAll(".outText").remove();
d3.selectAll(".mouseoverText").remove();

d3.selectAll(".hey"+thisCirc) //associated lines
	.transition()
	.attr("x2",function(d,i){
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
					return (subjX[k]-calcX[thisCirc])/(300/whatRadius[thisCirc]);
				}
				if(d==2||d==3||d==4){
					d=1;
				if (subjCode[k]==d){
					return (subjX[k]-calcX[thisCirc])/(300/whatRadius[thisCirc]);		
					}			
				}
			}
	})
	.attr("y2",function(d,i){
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
					return (subjY[k]-calcY[thisCirc])/(300/whatRadius[thisCirc]);
				}
				if(d==2||d==3||d==4){
					d=1;
				if (subjCode[k]==d){
					return (subjY[k]-calcY[thisCirc])/(300/whatRadius[thisCirc]);		
					}			
				}
			}
		})
}

var incomingSplit = [];
var incomingIs = [];
var whichBooks = [];
var manyBooks = [];
var manyIds = [];
var manyCodes = [];
var dividedCodes = [];
var saveId = [];

function loadBooks(){
		// console.log(manyBooks.length+codeSorted.length+manyIds.length+"hey");

d3.tsv("all_id_codes_title_top25.txt", function(error, data) {
for (j=0; j<data.length; j++){
	manyBooks.push(data[j].title);
	manyIds.push(data[j].id);
	manyCodes.push(data[j].code);
}
for (i=0; i<manyCodes.length; i++){
	dividedCodes.push(manyCodes[i].split(","));
}
for (j=0; j<dividedCodes.length; j++){
	codeSorted.push((dividedCodes[j].sort(function(a, b){return a-b})).toString());
}

})
	// console.log(manyBooks.length+codeSorted.length+manyIds.length+"hey");

}

var testing;
var newChecked = [];
var codeSorted = [];
var otherFirst = [];
var booksChecked = [];
var overFour = 0;
var bookColors = [];
var manyBookColors = {};
var checkAgainst;
function otherBooks(checkedTo, thisCircle){
	console.log(manyBooks.length+" "+codeSorted.length+" "+manyIds.length)

console.log("otherBooks"+checkedTo+"i"+thisCircle);
whichBooks.length = 0;
checkAgainst = thisCircle;
		// d3.select("#booksColumn").style("display","none");	
		// d3.select("#exit").transition().style("display","block")

// for (i=0; i<checkedIt.length; i++){
// 	booksChecked.push(checkedIt[i])
// }
for (i=0; i<checkedTo.length; i++){
	booksChecked.push(checkedIt[i])
}
// booksChecked = checkedIt;

booksChecked.sort(function(a, b){return a-b});
		// console.log(booksChecked+"books checked sorted")
		// console.log(manyBooks.length+codeSorted.length+manyIds.length+"hey");
for (j=0; j<booksChecked.length; j++){
		if (booksChecked[j]>4){
			overFour = 1;
			// console.log("yes")
			// console.log(booksChecked[j]+"at j over four")
		}
	}
if (overFour==1){
for (i=0; i<codeSorted.length; i++){
	if (codeSorted[i]==booksChecked.toString()){
		// console.log(manyBooks.length+codeSorted.length+manyIds.length+"hey");
		whichBooks.push(manyBooks[i]);
		saveId.push(manyIds[i]);
// console.log(whichBooks.length+"in other books")

	}
}
}

////SPLICE IN A 2 AND COMPARE
for (j=0; j<booksChecked.length; j++){

if (booksChecked[j]==1){
	booksChecked.splice(j,1,"2")
	for (i=0; i<codeSorted.length; i++){
		if (codeSorted[i]==booksChecked.toString()){
			whichBooks.push(manyBooks[i]);
			saveId.push(manyIds[i]);
		}
	}
	}
if (booksChecked[j]==2){
	booksChecked.splice(j,1,"3")
	for (i=0; i<codeSorted.length; i++){
		if (codeSorted[i]==booksChecked.toString()){
			whichBooks.push(manyBooks[i]);
			saveId.push(manyIds[i]);
		}
	}		
	}
if (booksChecked[j]==3){
	booksChecked.splice(j,1,"4")
	for (i=0; i<codeSorted.length; i++){
		if (codeSorted[i]==booksChecked.toString()){
			whichBooks.push(manyBooks[i]);
			saveId.push(manyIds[i]);
		}
	}		
	}
}
// booksChecked.length = 0;

updateHoverbox(whichBooks, saveId);
console.log(whichBooks.length)
}

var matchingArray = [];
var matched = [];
var saveClicked;
var bigBooksTrue = false;
function books(incoming, thisCircle){
if (thisCircle==checkAgainst){

}

else{
	whichBooks.length=0;
saveId.length = 0;

	d3.selectAll(".listBooks").remove();
		d3.select("#booksColumn").style("display","none");	
		d3.select("#exit").transition().style("display","block")

if (thisCircle<6){
		console.log("indexbig")

if (thisCircle==1){
	bigBooksTrue = true;
updateHoverbox(bigBooksOne, bigBooksOne);
}
if (thisCircle==2){
	// console.log("indexbig")
	bigBooksTrue = true;
updateHoverbox(bigBooksTwo, bigBooksTwo);
}
if (thisCircle==3){
	// console.log("indexbig")
	bigBooksTrue = true;
updateHoverbox(bigBooksThree, bigIdsThree);
}
if (thisCircle==4){
	// console.log("indexbig")
	bigBooksTrue = true;
updateHoverbox(bigBooksFour, bigIdsFour);
}

if (thisCircle==5){
	// console.log("indexbig")
	bigBooksTrue = true;
updateHoverbox(bigBooksFive, bigIdsFive);
}
}


else{
	bigBooksTrue=false;
saveClicked = thisCircle;
clicked = 0;
incomingIs = incoming.toString();
incomingSplit = incomingIs.split(",");
			for (j=0; j<manyCodes.length; j++){
				if (manyCodes[j]==incomingSplit){ 
					// console.log(manyCodes[j]+" matching "+incomingSplit)
					whichBooks.push(manyBooks[j]);
					saveId.push(manyIds[j]);
					updateHoverbox(whichBooks, manyIds[j]);
				}
			}

}
}
}
//Setup hover box
 hoverbox = d3.select("#hoverbox");
 var itsHeight;
 var clickOut = false;
var updateHoverbox = function(theseBooks, whichCode) {
	console.log(theseBooks)
d3.select("#hoverbox")
.transition()
// .delay(500)
// .duration(1000)
.style("width","186px")
.each("end", function(){
d3.select("#hoverbox").transition().style("opacity",.8)


})
if(bigBooksTrue){
var bookList = hoverbox
   .selectAll(".listBooks")
   .data(theseBooks) //not whichbooks?
		.enter()
		.append("text")
		// .append("p")
		.attr("class","listBooks")
		.text(function(d){
			return d;
		})
		.attr("x",0)
		.attr("y",0)
		.on("click", function(d,i){
			 window.open('http://clio.columbia.edu/catalog/'+saveId[i]+'.html');
		});
	}
else{
var bookList = hoverbox
   .selectAll(".listBooks")
   .data(whichBooks) //not whichbooks?
		.enter()
		.append("text")
		// .append("p")
		.attr("class","listBooks")
		.text(function(d){
			return d;
		})
		.attr("x",0)
		.attr("y",0)
		.on("click", function(d,i){
			 window.open('http://clio.columbia.edu/catalog/'+saveId[i]+'.html');
		});
	}
$('#hoverbox').tipsy({ 
		gravity: 'se', 
		html: true, 
		title: function() {
	return "Click for Columbia Library Listing"

		}
});
	itsHeight = $("#hoverbox").height();

};
$('#graphIcon').tipsy({
	gravity: 'sw',
	html:true,
	title: function(){
		return "Subject Frequency"
	}
})
function hideBooks(){

removeOutwardLines(littleCircChecked, littleCircIndex); //FIX CODENAME
// for (i=0; i<calcX.length; i++){
// 	d3.selectAll("text.mouseoverText"+i).remove();
// 	d3.selectAll("circle.inCircle"+i)
// 		.transition()
// 		.attr("fill", "gray")
// 		.attr("opacity",.1);

// 	//.remove();
// }
			d3.select("circle.inCircle"+littleCircIndex)
			.transition()
			.attr("fill","grey")
			.attr("opacity",.1);
clickOut = false;
littleCircChecked.length=0;
countLittleCircle = 0;
whichBooks.length = 0;
saveId.length = 0;

d3.select("#hoverbox")
.transition()
.style("opacity",0)
.each("end",function(){
	d3.select("#hoverbox").transition().style("width","0px");
})
d3.select("#container")
	.transition()
	.style("opacity", "1");
d3.select("#container").style("pointer-events","auto");

d3.select("#booksColumn").transition().style("display","block");	
d3.select("#exit").transition().style("display","none")

d3.selectAll(".listBooks").remove();


}


function noSubjEtc(){
	for (i=0; i<calcX.length; i++){
	d3.selectAll("text.mouseoverText"+i).remove();
	d3.selectAll("circle.inCircle"+i)
		.transition()
		.attr("fill", "gray")
		.attr("opacity",.1);
}
	for (z=0; z<subjCode.length; z++){
		d3.selectAll(".linesIn"+subjCode[z]).remove();


storeClicks[z] = 0;

	d3.selectAll(".surroundingPoints"+subjCode[z])
		.transition()
		.attr("y", subjY[z]+5)
		.attr("height",.1)
}
d3.selectAll("line.checkedLinesOut")
	.transition()
	.attr("x2",0)
	.attr("y2",0)


checkedIt.length=0;
booksChecked.length = 0;
whichBooks.length = 0;
checkedIndex = 0;
d3.select("#booksColumn").transition().style("display","block");
d3.select("#booksColumn.selected").classed("selected", false);	
}


$("#clearAll").on("click", function(){
clearEverything();
})
function clearEverything(){
			 $("#introNav2").hide();
		$("#skip2").hide();
		// d3.select("#skip2").css("display","none");

	console.log("clear everything")
   vis.attr("transform",
      "translate("+ 0 + "," + 0 + ")"
      + " scale(" + initialZoom + ")");
	showReset = false;
	console.log(showReset)
// d3.select("#inner")
// .transition()
// .style("display","none");
// 		d3.selectAll(".innerText").remove();	
			matching = 0;

	hideBooks();
for (i=0; i<calcX.length; i++){
	d3.selectAll("text.mouseoverText"+i).remove();
	d3.selectAll("circle.inCircle"+i)
		.transition()
		.attr("fill", "gray")
		.attr("opacity",.1);
}
	for (z=0; z<subjCode.length; z++){
		d3.selectAll(".linesIn"+subjCode[z]).remove();


storeClicks[z] = 0;

	d3.selectAll(".surroundingPoints"+subjCode[z])
		.transition()
		.attr("y", subjY[z]+5)
		.attr("height",.1)
}
d3.selectAll("line.checkedLinesOut")
	.transition()
	.attr("x2",0)
	.attr("y2",0)


checkedIt.length=0;
booksChecked.length = 0;
whichBooks.length = 0;
checkedIndex = 0;
d3.select("#booksColumn").transition().style("display","block");
d3.select("#booksColumn.selected").classed("selected", false);		
d3.select("#exit").transition().style("display","none")
  				$("#intro14").hide();
  				$(".introZoom").hide();
}

function processBigs(codeBig, indexBig){

incomingBig = oneBig.toString();
splitBig = incomingBig.split(",");
			for (j=0; j<manyCodes.length; j++){
				if (manyCodes[j]==splitBig){ 
					bigBooks.push(manyBooks[j]);
					saveBigIds.push(manyIds[j]);
				}
			}

}
var bigBooksZero = [];
var bigIdsZero= [];
var bigBooksOne= [];
var bigIdsOne= [];
var bigBooksTwo= [];
var bigIdsTwo= [];
var bigBooksThree= [];
var bigIdsThree= [];
var bigBooksFour= [];
var bigIdsFour= [];
var bigBooksFive= [];
var bigIdsFive= [];
function processBigs1(codeBig, indexBig){

incomingBig = codeBig.toString();
splitBig = incomingBig.split(",");
			for (j=0; j<manyCodes.length; j++){
				if (manyCodes[j]==splitBig){ 
					if(indexBig==0){
					bigBooksZero.push(manyBooks[j]);
					bigIdsZero.push(manyIds[j]);
					}
					if(indexBig==1){
					bigBooksOne.push(manyBooks[j]);
					bigIdsOne.push(manyIds[j]);
					}
					if(indexBig==2){
					bigBooksTwo.push(manyBooks[j]);
					bigIdsTwo.push(manyIds[j]);
					}
					if(indexBig==3){
					bigBooksThree.push(manyBooks[j]);
					bigIdsThree.push(manyIds[j]);
					}
					if(indexBig==4){
					bigBooksFour.push(manyBooks[j]);
					bigIdsFour.push(manyIds[j]);
					}
					if(indexBig==5){
					bigBooksFive.push(manyBooks[j]);
					bigIdsFive.push(manyIds[j]);
					}																				
				}

			}

}
var specialCirc = 393;
var p0 = [width/2, height/2, windowHeight],
    p1 = [width/2+conn_levels[2], height/2, 100],
    p2 = [width/2+conn_levels[3], height/2, 100];
    p3 = [width/2+conn_levels[4], height/2, 100];
    p4 = [width/2+conn_levels[5], height/2, 100];
    p5 = [width/2+conn_levels[6], height/2, 100];
	p5half =  [width/2+conn_levels[6], height/2, 200];
var p6half;
    //going to special circle
    p6 = [width/2+conn_levels[4], height/2, 100];
    var p7; //= [width/2+conn_levels[4], height/2, 100];
	p8 = [width/2, height/2, windowHeight];
	var specialSubj1 = 19;
	var specialIndex1;
	var specialSubj2 = 5;
	var specialIndex2;
	var specialSubj3 = 12;
	var specialIndex3;

    var clickedSubline = false;

$("#subline").click(function(){
	$("#about2").hide("fast");
	$("#about").toggle("fast");
//first transition
	d3.select("#about").on("click",function(){
	// svg.call(transition, p0, p1);
	// svg.call(transition, p6,p6)
	})
})
$("#subline2").click(function(){
	$("#about").hide("fast");

	$("#about2").toggle("fast");

})

var center = [width / 2, height / 2];

function zoomOpening(){
if (animateZoom){
		d3.select("#container").style("pointer-events","none");
	svg.call(transition, p0, p1); //SKIP AHEAD
}
if (animateZoom==false){
skipIntro2();
	resetZoom();
}
}



function transition(svg, start, end) {
if (animateZoom==false){
		// console.log(animateZoom+"animateZoom")
skipIntro2();
resetZoom();
}

var countZoom = 0;

if (animateZoom){
	// console.log(animateZoom+"animateZoom")
if (animateZoom==false){
skipIntro2();
resetZoom();
}
var  i = d3.interpolateZoom(start, end);

  vis
      .attr("transform", transform(start))
    .transition()
      // .delay(250)
      .delay(1000)

      .duration(i.duration * 2)
      .attrTween("transform", function() { return function(t) { return transform(i(t)); }; })
      .each("end", function() { 
if (end==p1){

	$("#intro4half").show("fast", function(){
	});
	d3.select(".ringCircle"+(p1[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.delay(4000) //at least!
	.duration(1000)
	.attr("stroke-width",1)
    .each("end", function(){
 if (animateZoom==false){
 		clearEverything();
 	$('#introNav2').hide()
}
else{
$('#introNav2').show().on("click", function(){
      	$('#introNav2').slideUp();
      	svg.call(transition,p1,p2);
      })
}
     })
 }
if(end==p2){
$("#intro5").show("fast");

	d3.select(".ringCircle"+(p2[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.duration(500)
	.attr("stroke-width",1)
	.each("end",function(){
 if (animateZoom==false){
 		clearEverything();
 	$('#introNav2').hide()
}
else{
		$('#introNav2').show().on("click", function(){
	      	$('#introNav2').slideUp();
	      	svg.call(transition,p2,p3);
      })
}
    })
}
if(end==p3){
	$("#intro6").show("fast");

	d3.select(".ringCircle"+(p3[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.duration(500)
	.attr("stroke-width",1)
	.each("end",function(){
 if (animateZoom==false){
 		clearEverything();
 	$('#introNav2').hide()
}
else{
		$('#introNav2').show().on("click", function(){
			$('#introNav2').slideUp();
			svg.call(transition,p3,p4);	      	
      }) 
 }     	
      })
}
if(end==p4){
	$("#intro7").show("fast");

	d3.select(".ringCircle"+(p4[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.duration(500)
	.attr("stroke-width",1)
	.each("end",function(){
 if (animateZoom==false){
 		clearEverything();
 	$('#introNav2').hide()
}
else{		
		$('#introNav2').show().on("click", function(){
      				$('#introNav2').slideUp();
      	svg.call(transition,p4,p5);
      })
}    
      })
}
if(end==p5){
		$("#intro4, #intro4half, #intro5, #intro6, #intro7").hide("fast");

$(".introZoom").animate({
top: "160px",
width: "188px",
left: "392px",
});

$("#introNav2").animate({
top: "160px",
left: "448px",
});
$("#intro8").show("fast")
   	p6half = [calcX[specialCirc-200], calcY[specialCirc-200], 50];

	d3.select(".ringCircle"+(p5[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.delay(3000)
	.duration(1000)
	.attr("stroke-width",1)
	.each("end",function(){

	$("#intro8").hide("fast", function(){
	});
 if (animateZoom==false){
 		clearEverything();
 	// $('#introNav2').hide()
}
else{
		// $('#introNav2').show().on("click", function(){
	svg.call(transition, p5half,p6half);
      				// $('#introNav2').hide();
      // })
}
})
}

if (end==p6half){
		$("#introNav2").animate({
			top:"201px",
			left: "597px",
		});
	$("#intro8half").show("slow");
 if (animateZoom==false){
 		clearEverything();
 	$('#introNav2').hide()
}
else{
		$('#introNav2').show().on("click", function(){
      				$('#introNav2').slideUp();
      	svg.call(transition,p6half,p6);
		// $(".introZoom").animate({
		// 	left: "539px",
		// });
      })
	}
     
      	console.log("ok")
}

if(end==p6){
		$(".introZoom").animate({
			left: "539px",
		});
		$("#introNav2").animate({
			top:"201px",
			left: "744px",
		});
		// $("#introZoom").animate({
		// 	left: "539px",
		// });
		
	$("#intro8half").hide("fast");
   p7 = [calcX[specialCirc], calcY[specialCirc], 100];

  d3.select("circle.inCircle"+specialCirc)
  .transition()
  .attr("opacity","1")
  .each("end",function(){
	$("#intro9").show("slow"); //each circle represents a collection of books related to a unique set of subjects
   d3.selectAll("line.hey"+specialCirc) //	.attr("class", "hey"+thisCircle)//"linesOut"
      	.transition()
      	.attr("opacity",1)
      	// .delay(2000)
  	.each("end",function(){
if (animateZoom==false){
 		clearEverything();
 	$('#introNav2').hide()
}
else{
  		$('#introNav2').show().on("click", function(){

      	svg.call(transition,p6,p7);
      })
}
      });  	
  })
}
if(end==p7){
		$(".introZoom").animate({
			top:"145px",
			left:"460px",
		});
		$("#introNav2").animate({
			top:"155px",
			left: "665px",
		});
	//here we will do something like make 
	//then we also want to zoom out
//ALLMOUSEOVERTEXT  d3.select("circle.inCircle"+specialCirc)
  d3.select("circle.inCircle"+specialCirc)
  .transition()
  .duration(1000)
  .attr("stroke","yellow")
  .attr("stroke-width",function(){
  		$("#intro10").show("fast"); //SIZE
		return 3; 
	})
  .each("end",function(){
  d3.select("circle.inCircle"+specialCirc)
  .transition()
  .delay(3000)
  .duration(1000)
  .attr("stroke-width",2)
  .each("end",function(){
  d3.select("circle.inCircle"+specialCirc)
  .transition()
  .attr("stroke-width",1)
  .attr("stroke","white")
  // })  

  	.each("end",function(){
	$("#intro9, #intro10").hide("fast");
  	$("#intro11").show("slow"); //SUBJECTS
   	allOut(allCodes[specialCirc], specialCirc); //FIX WHAT THING IS NOW
  	d3.selectAll("line.hey"+specialCirc)
	.transition()
	.delay(2000)
	.duration(2000)
	.attr("stroke-width",2)
		.each("end",function(){
 if (animateZoom==false){
 		clearEverything();
 	$('#introNav2').hide()
}
else{			
		  $('#introNav2').show().on("click", function(){
		  $('#introNav2').slideUp();			
			svg.call(transition,p7, p8);  
		})
}
  		})
	})
})
})
}





if(end==p8){
	$("#intro11").hide("fast");
$(".introZoom").delay(1000).animate({
left:"90px",
top:"300px",

});

$('#introNav2').delay(2000).animate({
	left:"296px",
	top:"350px",
})


//FIGURE OUT HOW TO ANIMATE THE CSSS HERE I THINK?


d3.selectAll("line.hey"+specialCirc)
	.transition()
	.delay(1200)
	.attr("x2",0)
	.attr("y2",0)
	.each("end",function(){
  	$("#intro12").show("fast"); //SUBJECTS		
	})
d3.select("circle.inCircle"+specialCirc)
  	.transition()
  	.duration(300)
  	.attr("opacity",".1")
  	.each("end",function(){

///////////////////first subject

//SELECT ONE SUBJECT "CLICK IT"

			matching = 0;

for (i=0; i<subjCode.length; i++){ 
	if (subjCode[i]==specialSubj1){ 
		specialIndex1 = i; 
	}
	if (subjCode[i]==specialSubj2){ 
		specialIndex2 = i; 
	}
	if (subjCode[i]==specialSubj3){ 
		specialIndex3 = i; 
	}
}
		d3.select(".surroundingPoints"+specialSubj1)
			.transition()
			.delay(500)
			.duration(1000)
			.attr("y", subjY[specialIndex1]-10)
			.attr("height",14)
			.attr("stroke", colors[subjLoc[specialIndex1]])
			.each("end",function(){
			runLines(specialSubj1);
			checkedIt.push(specialSubj1);
			checked(checkedIt);				

		d3.select(".surroundingPoints"+specialSubj2)
			.transition()
			.delay(500)
			.duration(2000)
			.attr("y", subjY[specialIndex2]-10)
			.attr("height",14)
			.attr("stroke", colors[subjLoc[specialIndex2]])
			.each("end",function(){
			runLines(specialSubj2);
			checkedIt.push(specialSubj2);
			checked(checkedIt);				
						//open books column
  	$("#intro12").hide("fast"); //SUBJECTS

$(".introZoom").delay(2000).animate({
left:"68%",
top:"100px",
});


		$("#intro13").delay(3000).show();
		
d3.select("#container").style("pointer-events","none");

  				$("#intro14").delay(4000).show("slow", function(){
  d3.select("#container")
.transition()
	.style("opacity", .5)

					})	
			})		
		})

  	})
}
});

  function transform(p) {
    var k = height / p[2]; //*2;
    return "translate(" + (center[0] - p[0] * k) + "," + (center[1] - p[1] * k) + ")scale(" + k + ")";
  	}
}
}

</script>

</body>
</html>